<script type="text/javascript">

  jQuery(function($) {
    CartJS.init({{ cart | json }}, {
      "dataAPI": true,
      "moneyFormat": "{{ shop.money_format }}",
      "moneyWithCurrencyFormat": "{{ shop.money_with_currency_format }}"
    });

    jQuery('.zpa-published-page-holder a[href="/cart"]').click(function(e) {
      e.preventDefault();
      window.dispatchEvent( new CustomEvent('open-cart', {'detail': {open: true}}) ); 
      return false;
    });

    function getFormData($form){
        var unindexed_array = $form.serializeArray();
        var indexed_array = {};

        jQuery.map(unindexed_array, function(n, i){
            indexed_array[n['name']] = n['value'];
        });

        return indexed_array;
    }

    jQuery('form[data-zp-add-to-cart-form]').submit(function(e) {
      e.preventDefault();
      var formData = getFormData($(this));
      var variantId = $(this).find('select option[selected="selected"]').attr("value");
      var quantity = $(this).find('input[name="quantity"]').val()
      CartJS.addItem(formData.id, formData.quantity)
      if (fbq) {
        var price = $(this).find("div[data-zp-product-price]").html();
        price = price.replace("â‚¬", "")
        price = price.replace(",", ".")
        fbq('track', 'AddToCart', {
          content_ids: [formData.id],
          content_type: 'product',
          value: price,
          quantity: parseInt(formData.quantity),
          currency: 'EUR' 
        });  
      }
      window.dispatchEvent( new CustomEvent('open-cart', {'detail': {open: true}}) );

      return false;
    });
    
    $(document).on('cart.requestComplete', function(event, cart) {
      window.dispatchEvent( new CustomEvent('open-cart', {'detail': {open: true}}) );
      window.dispatchEvent( new CustomEvent('cart-update', {'detail': {cart: cart}}) );
      $("#CartCount").html(cart.item_count);

      if (cart.item_count == 1 && cart.total_price == 0) {
        CartJS.updateItem(1, 0);
      }
      if(cart.item_count > 0) {
        $('.sidebar__cart-handle').addClass('sidebar__cart-handle--has-items');
      } else {
        $('.sidebar__cart-handle').removeClass('sidebar__cart-handle--has-items');
      }
    });

    $("#cart-trigger").click(function(e) {
      e.preventDefault();
      $(document).trigger("cart.openCart");
      return false;
    });
  });
</script>